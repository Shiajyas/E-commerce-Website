<%- include("../partials/header") %>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Pages
                <span></span> Account
            </div>
        </div>
    </div>

    <section class="pt-150 pb-150 full-width-section">
        <div class="container">
            <% if (success && success.length > 0) { %>
                <div class="alert alert-success alert-dismissible fade show font-weight-bold" role="alert">
                    <%= success[0] %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-3 mb-4">
                    <div class="dashboard-menu shadow-sm rounded p-3 bg-white">
                        <ul class="nav flex-column" role="tablist">
                            <li class="nav-item mb-2">
                                <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard"
                                   role="tab" aria-controls="dashboard" aria-selected="true">
                                    <i class="fi-rs-settings-sliders me-2"></i>Dashboard
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab"
                                   aria-controls="orders" aria-selected="false">
                                   <i class="fi-rs-shopping-bag me-2"></i>Orders
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" id="wallet-tab" data-bs-toggle="tab" href="#track-orders" role="tab"
                                   aria-controls="track-orders" aria-selected="false">
                                   <i class="fi-rs-shopping-cart-check me-2"></i>Wallet Status
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" id="wallet-history-tab" data-bs-toggle="tab" href="#wallet-history"
                                   role="tab" aria-controls="wallet-history" aria-selected="false">
                                   <i class="fi-rs-history me-2"></i>Wallet History
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" id="referal-tab" data-bs-toggle="tab" href="#referal"
                                   role="tab" aria-controls="referal" aria-selected="false">
                                   <i class="fi-rs-gift me-2"></i>Referrals
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address"
                                   role="tab" aria-controls="address" aria-selected="false">
                                   <i class="fi-rs-marker me-2"></i>My Address
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail"
                                   role="tab" aria-controls="account-detail" aria-selected="false">
                                   <i class="fi-rs-user me-2"></i>Account Details
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-danger" href="/logout">
                                    <i class="fi-rs-sign-out me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-9">
                    <div class="tab-content">

                        <!-- Dashboard Tab -->
                        <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">User Profile</h5>
                                </div>
                                <div class="card-body text-center">
                                    <% let profileImage = user.images && user.images.length ? user.images[0] : '/user-assets/imgs/theme/icons/user-profile.svg'; %>
                                    <img src="/uploads/product-images/<%= user.images[0] %>" 
                                         class="rounded-circle mb-3" 
                                         alt="Profile" style="width: 120px; height: 120px; object-fit: cover;">
                                    <h5 class="mb-1"><%= user.name %></h5>
                                    <p class="mb-1"><strong>Email:</strong> <%= user.email %></p>
                                    <p class="mb-1"><strong>Phone:</strong> <%= user.phone %></p>
                                </div>
                            </div>
                        </div>

                        <!-- Orders Tab -->
                       <div class="tab-pane fade" id="orders" role="tabpanel">
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Your Orders</h5>
            <select id="statusFilter" class="form-select w-auto">
                <option value="all">All</option>
              
                <option value="Delivered">Delivered</option>
                <option value="Confirmed">Confirmed</option>
                <option value="Returned">Returned</option>
                <option value="Canceled">Canceled</option>
                <option value="Shipped">Shipped</option>
                <option value="Failed">Failed</option>
            </select>
        </div>
      <div class="card-body table-responsive">
    <table id="orderTable" class="table table-bordered text-center mb-0">
        <thead class="table-light">
            <tr>
            <th>Date</th>
                <th>Status</th>
                
                <th>Total</th>
                <th>Failure Reason</th>
                <th>Actions</th>
            </tr>
        </thead>
      <tbody id="orderTableBody">
  <% order
    .filter(o => o.status !== 'Pending')
    .forEach(o => { %>

    <tr class="order-row"
        data-status="<%= o.status %>"
        data-created-on="<%= o.createdOn %>">

   <td><%= new Date(o.createdOn).toLocaleDateString() %></td>

      <td>
        <span class="badge
          <%= o.status === 'Delivered' ? 'bg-success' :
              o.status === 'Failed' ? 'bg-danger' :
              o.status === 'Confirmed' ? 'bg-primary' :
              'bg-secondary' %>">
          <%= o.status %>
        </span>
      </td>

      
      <td>₹<%= o.totalPrice %></td>

      <td>
        <% if (o.status === 'Failed' && o.failure?.reason) { %>
          <span class="reason-tooltip">
            <%= o.failure.reason.slice(0, 25) %>…
            <span class="tooltip-box">
              <%= o.failure.reason %>
            </span>
          </span>
        <% } else { %>
          -
        <% } %>
      </td>

      <td>
        <a href="/orderDetails?id=<%= o._id %>"
           class="btn btn-sm btn-primary">View</a>
      </td>
    </tr>

  <% }) %>

  <tr id="noResultRow" style="display:none;">
    <td colspan="6">No results found</td>
  </tr>
</tbody>

    </table>

    <!-- Pagination Controls -->
    <nav>
        <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
    </nav>
</div>

        <div class="card-footer text-center">
            <nav>
                <ul class="pagination justify-content-center mb-0" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

                        <!-- Wallet Tab -->
                        <div class="tab-pane fade" id="track-orders" role="tabpanel">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Wallet</h5>
                                </div>
                                <div class="card-body text-center">
                                    <h3>₹<%= user.wallet %></h3>
                                    <button class="btn btn-success mt-3" onclick="addMoney()">Add Money</button>
                                </div>
                            </div>
                        </div>

                        <!-- Wallet History Tab -->
                        <div class="tab-pane fade" id="wallet-history" role="tabpanel">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Wallet History</h5>
                                </div>
                                <div class="card-body table-responsive">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if(user.history && user.history.length){ %>
                                                <% user.history.forEach(h => { 
                                                    const dateObj = new Date(h.date); %>
                                                    <tr>
                                                        <td><%= dateObj.toLocaleDateString() %></td>
                                                        <td><%= h.status %></td>
                                                        <td><%= h.status==="debit"? "-"+h.amount : h.amount %></td>
                                                    </tr>
                                                <% }) %>
                                            <% } else { %>
                                                <tr><td colspan="3" class="text-center">No history found</td></tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Referrals Tab -->
                        <div class="tab-pane fade" id="referal" role="tabpanel">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Referral Offer</h5>
                                </div>
                                <div class="card-body text-center">
                                    <p>Your referral code: <strong><%= user.referalCode || "Not Found" %></strong></p>
                                    <form onsubmit="verifyReferalCode(event)">
                                        <input type="text" id="referalCode" name="referalCode" class="form-control w-50 mx-auto mb-3" placeholder="Enter referral code" required>
                                        <button type="submit" class="btn btn-primary">Redeem</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Address Tab -->
                        <div class="tab-pane fade" id="address" role="tabpanel">
                            <div class="row g-4">
                                <% if(userAddress && userAddress.address.length){ %>
                                    <% userAddress.address.forEach(addr => { %>
                                        <div class="col-md-6">
                                            <div class="card h-100 shadow-sm border-0">
                                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0"><%= addr.addressType %></h6>
                                                    <div>
                                                        <a href="/editAddress?id=<%= addr._id %>" class="btn btn-sm btn-light">Edit</a>
                                                        <button onclick="confirmDeleteAddress('<%= addr._id %>')" class="btn btn-sm btn-danger">Delete</button>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>Name:</strong> <%= addr.name %></p>
                                                    <p><strong>City:</strong> <%= addr.city %></p>
                                                    <p><strong>Landmark:</strong> <%= addr.landMark %></p>
                                                    <p><strong>State:</strong> <%= addr.state %></p>
                                                    <p><strong>Pincode:</strong> <%= addr.pincode %></p>
                                                    <p><strong>Phone:</strong> <%= addr.phone %></p>
                                                    <% if(addr.altPhone){ %>
                                                        <p><strong>Alt Phone:</strong> <%= addr.altPhone %></p>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <div class="col-12 text-center">
                                        <p class="text-muted">No addresses added yet.</p>
                                    </div>
                                <% } %>

                                <div class="col-12 text-center">
                                    <a href="/addAddress" class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i>Add Address</a>
                                </div>
                            </div>
                        </div>

                        <!-- Account Details Tab -->
                        <div class="tab-pane fade" id="account-detail" role="tabpanel">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5>Account Details</h5>
                                </div>
                                <div class="card-body">
                                    <form id="userDetailsForm" enctype="multipart/form-data">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label>Name *</label>
                                                <input type="text" name="name" value="<%= user.name %>" class="form-control" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label>Phone *</label>
                                                <input type="text" name="phone" value="<%= user.phone %>" class="form-control" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label>Profile Image</label><br>
                                                <img id="imagePreview" src="<%= user.images && user.images.length>0 ? '/uploads/product-images/'+user.images[0] : '/user-assets/imgs/theme/upload.svg' %>" 
                                                     style="max-width:200px; max-height:200px; cursor:pointer;" 
                                                     onclick="document.getElementById('imageInput').click()">
                                                <input type="file" id="imageInput" name="images" accept="image/*" class="form-control mt-2" onchange="updatePreview(event)">
                                            </div>
                                            <div class="col-12 mt-3">
                                                <button type="submit" class="btn btn-success w-100">Save Changes</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<%- include("../partials/footer") %>
<script>
const rowsPerPage = 5;
let currentPage = 1;

const rows = [...document.querySelectorAll('.order-row')];
const pagination = document.getElementById('pagination');
const filter = document.getElementById('statusFilter');
const noRow = document.getElementById('noResultRow');

function getVisibleRows() {
  const status = filter.value;
  return rows.filter(row =>
    status === 'all' || row.dataset.status === status
  );
}

function renderTable() {
  const visibleRows = getVisibleRows();

  rows.forEach(r => r.style.display = 'none');

  visibleRows.forEach((row, index) => {
    row.style.display =
      index >= (currentPage - 1) * rowsPerPage &&
      index < currentPage * rowsPerPage
        ? ''
        : 'none';
  });

  noRow.style.display = visibleRows.length ? 'none' : '';
}

function setupPagination() {
  const visibleRows = getVisibleRows();
  pagination.innerHTML = '';

  const pageCount = Math.ceil(visibleRows.length / rowsPerPage);
  if (!pageCount) return;

  for (let i = 1; i <= pageCount; i++) {
    const li = document.createElement('li');
    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
    li.innerHTML = `<a class="page-link">${i}</a>`;
    li.onclick = () => {
      currentPage = i;
      renderTable();
      setupPagination();
    };
    pagination.appendChild(li);
  }
}

filter.addEventListener('change', () => {
  currentPage = 1;
  renderTable();
  setupPagination();
});

// Initial load
renderTable();
setupPagination();
</script>

<!-- JS Scripts -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
function updatePreview(event){
    const preview=document.getElementById('imagePreview');
    if(event.target.files && event.target.files[0]){
        const reader=new FileReader();
        reader.onload=e=>preview.src=e.target.result;
        reader.readAsDataURL(event.target.files[0]);
    }
}

// Order Filter + Sort
document.getElementById('statusFilter').addEventListener('change', function(){
    const selected=this.value;
    const rows=[...document.querySelectorAll('#orderTable .order-row')];
    const noRow=document.getElementById('noResultRow');
    let hasResults=false;

    // Sort descending
    rows.sort((a,b)=>new Date(b.dataset.createdOn)-new Date(a.dataset.createdOn));
    rows.forEach(r=>r.parentElement.appendChild(r));

    rows.forEach(r=>{
        if(selected==='all'||r.dataset.status===selected){
            r.style.display=''; hasResults=true;
        } else r.style.display='none';
    });
    noRow.style.display=hasResults?'none':'';
});

// Profile Form Submit
document.getElementById('userDetailsForm').addEventListener('submit', function(e){
    e.preventDefault();
    const formData=new FormData(this);
    fetch('/editUserDetails?id=<%= user._id %>',{method:'POST',body:formData})
        .then(res=>res.json())
        .then(data=>{
            if(data.success) Swal.fire('Success',data.message,'success').then(()=>window.location.reload());
            else Swal.fire('Error',data.message,'error');
        }).catch(()=>Swal.fire('Error','Something went wrong','error'));
});

// Wallet Add Money
async function addMoney(){
    const { value: amount } = await Swal.fire({title:'Enter Amount',input:'number',inputPlaceholder:'₹'});
    if(!amount) return;
    $.post('/addMoney',{total:amount}, data=>{
        if(data.razorpay){
            const options={
                key:"rzp_test_297s5pqDLLHUia",
                amount:data.order.amount,
                currency:"INR",
                name:"LapLux",
                description:"Wallet Topup",
                order_id:data.order.id,
                handler:res=>verifyPayment(res,data),
                theme:{color:"#3399cc"}
            };
            new Razorpay(options).open();
        }
    });
}

function verifyPayment(response, order){
    $.post('/verify-payment',{response,order,from:"wallet"},res=>{
        if(res) Swal.fire('Success','Payment successful','success').then(()=>location.reload());
        else Swal.fire('Error','Payment failed','error');
    });
}

// Referral
function verifyReferalCode(e){
    e.preventDefault();
    const code=document.getElementById('referalCode').value;
    $.post('/verifyReferalCode',{referalCode:code},res=>{
        Swal.fire({icon:res.success?'success':'success',title:res.success?'Success':'success',text:res.message});
    });
}

// Delete Address
function confirmDeleteAddress(id){
    Swal.fire({title:'Confirm?',text:'Delete this address?',icon:'warning',showCancelButton:true,confirmButtonText:'Yes'})
        .then(result=>{
            if(result.isConfirmed) fetch(`/deleteAddress?id=${id}`,{method:'DELETE'})
                .then(r=>r.json()).then(data=>{
                    Swal.fire(data.success?'Deleted!':'Error',data.message,data.success?'success':'error')
                        .then(()=>location.reload());
                });
        });
}
</script>

<script>
    
const rowsPerPage = 5; // number of rows per page
let currentPage = 1;

const orderRows = Array.from(document.querySelectorAll('#orderTableBody .order-row'));
const pagination = document.getElementById('pagination');
const noResultRow = document.getElementById('noResultRow');

function renderTable() {
    const selectedStatus = document.getElementById('statusFilter').value;
    const filteredRows = orderRows.filter(row => selectedStatus === 'all' || row.dataset.status === selectedStatus);

    // Pagination calculations
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    currentPage = Math.min(currentPage, totalPages) || 1;
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    // Hide all rows first
    orderRows.forEach(r => r.style.display = 'none');
    // Show only filtered rows for current page
    filteredRows.slice(start, end).forEach(r => r.style.display = '');

    // Show/hide no result
    noResultRow.style.display = filteredRows.length === 0 ? '' : 'none';

    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    pagination.innerHTML = '';
    if(totalPages <= 1) return;

    for(let i = 1; i <= totalPages; i++){
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.addEventListener('click', e => {
            e.preventDefault();
            currentPage = i;
            renderTable();
        });
        pagination.appendChild(li);
    }
}

// Filter change
document.getElementById('statusFilter').addEventListener('change', () => {
    currentPage = 1;
    renderTable();
});

// Initial render
renderTable();
</script>

<script>
// Parameters
const rowsPerPage = 5; // change rows per page
const tableBody = document.getElementById('orderTableBody');
const pagination = document.getElementById('pagination');
let currentPage = 1;

// Get all rows except the noResultRow
let allRows = Array.from(tableBody.querySelectorAll('.order-row'));

// Sort rows by date descending
allRows.sort((a, b) => new Date(b.dataset.createdOn) - new Date(a.dataset.createdOn));

// Function to render page
function renderPage(page){
    const start = (page-1)*rowsPerPage;
    const end = start+rowsPerPage;

    allRows.forEach((row, index) => {
        row.style.display = (index >= start && index < end) ? '' : 'none';
    });

    document.getElementById('noResultRow').style.display = allRows.length ? 'none' : '';
    renderPagination(Math.ceil(allRows.length/rowsPerPage), page);
}

// Render pagination buttons
function renderPagination(totalPages, current){
    pagination.innerHTML = '';
    for(let i=1;i<=totalPages;i++){
        const li = document.createElement('li');
        li.className = `page-item ${i===current?'active':''}`;
        const a = document.createElement('a');
        a.className='page-link';
        a.href='#';
        a.innerText=i;
        a.onclick = (e)=>{ e.preventDefault(); renderPage(i); };
        li.appendChild(a);
        pagination.appendChild(li);
    }
}

// Filter by status
document.getElementById('statusFilter').addEventListener('change', function(){
    const selected = this.value;
    allRows.forEach(r => {
        r.style.display = (selected==='all' || r.dataset.status===selected) ? '' : 'none';
    });

    allRows = Array.from(tableBody.querySelectorAll('.order-row')).filter(r => r.style.display !== 'none');
    renderPage(1);
});

// Initial render
renderPage(currentPage);
</script>



<!-- CSS -->
<style>
.full-width-section{width:100%;overflow-x:hidden;background:#f8f9fa;}
.dashboard-menu .nav-link{color:#495057;font-weight:500;transition:.3s;}
.dashboard-menu .nav-link.active,.dashboard-menu .nav-link:hover{background:#f1f3f5;color:#007bff;border-radius:5px;}
.table th,.table td{vertical-align:middle;}
.table-responsive {
    overflow-x: auto;
}
.reason-tooltip-container {
    position: relative;
    display: inline-block;
    max-width: 150px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
}

.reason-tooltip-full {
    display: none;
    position: absolute;
    left: 100%; /* show on the right of the truncated text */
    top: 0;
    background: rgba(0,0,0,0.85);
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
    white-space: normal;
    max-width: 300px;
    z-index: 999;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.reason-tooltip-container:hover .reason-tooltip-full {
    display: block;
}


</style>
