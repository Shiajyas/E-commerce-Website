<%- include("../partials/header") %>

<style>
    body {
        background-color: #f5f5f5;
    }

    .checkout-section {
        padding: 40px 0;
    }

    .card {
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
        background-color: #fff;
    }

    .order-table img {
        width: 60px;
        height: auto;
        border-radius: 5px;
    }

    .use-button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.3s;
    }

    .use-button:hover {
        background-color: #45a049;
    }

    .input-group-append button {
        min-width: 100px;
    }

    .total-card {
        border-radius: 10px;
        padding: 20px;
        background-color: #fff;
    }

    .address-card {
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
</style>

<section class="checkout-section mt-90">
    <div class="container">
        <% let totalAmount = 0; %>
        <% if(isSingle && product && product.length > 0) totalAmount = product[0].salePrice; %>
        <% if(!isSingle && data && data.length > 0){ data.forEach(d => { totalAmount += d.productDetails[0].salePrice * d.quantity; }); } %>

        <div class="row">
            <!-- ORDER DETAILS -->
            <div class="col-lg-8">
                <div class="card p-3">
                    <h4>Your Orders</h4>
                    <div class="table-responsive mt-3">
                        <table class="table order-table text-center">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Product</th>
                                    <th>Regular</th>
                                    <th>Sale</th>
                                    <th>Offer</th>
                                    <th>Final</th>
                                    <th>Qty</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if(isSingle && product && product.length>0){ %>
                                    <% product.forEach(p => { %>
                                        <tr>
                                            <td><img src="<%= p.productImage[0] %>" alt="<%= p.productName %>"></td>
                                            <td><%= p.productName %></td>
                                            <td>₹<%= p.regularPrice %></td>
                                            <td>₹<%= p.salePrice %></td>
                                            <td>₹<%= p.regularPrice - p.salePrice %></td>
                                            <td>₹<%= p.salePrice %></td>
                                            <td>1</td>
                                            <td>₹<%= p.salePrice %></td>
                                        </tr>
                                    <% }) %>
                                <% } else if(data && data.length>0){ %>
                                    <% data.forEach(d => { %>
                                        <tr>
                                            <td><img src="/uploads/product-images/<%= d.productDetails[0].productImage[0] %>" alt="<%= d.productDetails[0].productName %>"></td>
                                            <td><%= d.productDetails[0].productName %></td>
                                            <td>₹<%= d.productDetails[0].regularPrice %></td>
                                            <td>₹<%= d.productDetails[0].salePrice %></td>
                                            <td>₹<%= d.productDetails[0].regularPrice - d.productDetails[0].salePrice %></td>
                                            <td>₹<%= d.productDetails[0].salePrice %></td>
                                            <td><%= d.quantity %></td>
                                            <td>₹<%= d.productDetails[0].salePrice * d.quantity %></td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="8">No products found</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ADDRESS SELECTION -->
                <div class="card p-3 mt-3">
                    <h4>Select Address</h4>
                    <div class="row mt-3">
                        <% if(locals.userAddress){ %>
                            <% userAddress.address.forEach(address => { %>
                                <div class="col-md-6 mb-3">
                                    <div class="address-card">
                                        <div class="form-check mb-2">
                                            <input type="radio" class="form-check-input" name="selectedAddress" id="addressRadio<%= address._id %>" value="<%= address._id %>">
                                            <label class="form-check-label" for="addressRadio<%= address._id %>">Select</label>
                                        </div>
                                        <strong><%= address.addressType %></strong>
                                        <address>
                                            <%= address.name %><br>
                                            <%= address.city %>, <%= address.landMark %><br>
                                            <%= address.state %> - <%= address.pincode %><br>
                                            Phone: <%= address.phone %>, Alt: <%= address.altPhone %>
                                        </address>
                                        <div class="d-flex justify-content-between mt-2">
                                            <a href="/editAddress?id=<%= address._id %>" class="btn btn-sm btn-outline-primary">Edit</a>

                                                        <button onclick="confirmDeleteAddress('<%= address._id %>')" class="btn btn-sm btn-danger">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="col-12">
                                <div class="address-card">No address found</div>
                            </div>
                        <% } %>
                        <div class="col-md-6 mb-3">
                            <a href="/addAddress" class="btn btn-primary w-100">Add Address</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAYMENT + TOTAL -->
            <div class="col-lg-4">
                <div class="card p-3">
                    <h4>Payment Options</h4>
                    <div class="form-check mt-2">
                        <input type="radio" class="form-check-input payment" name="payment_option" value="cod" id="CashOnDelivey" checked>
                        <label class="form-check-label" for="CashOnDelivey">Cash on Delivery</label>
                    </div>
                    <div class="form-check mt-2">
                        <input type="radio" class="form-check-input payment" name="payment_option" value="wallet" id="wallet">
                        <label class="form-check-label" for="wallet">Wallet</label>
                    </div>
                    <div class="form-check mt-2">
                        <input type="radio" class="form-check-input payment" name="payment_option" value="online" id="Razorpay">
                        <label class="form-check-label" for="Razorpay">Razorpay</label>
                    </div>

                    <h5 class="mt-4">Coupons</h5>
                    <% if (locals.coupons && coupons.length > 0){ %>
                        <select id="couponDropdown" class="form-select mb-2">
                            <option value="">Select a coupon</option>
                            <% coupons.forEach(c => { %>
                                <option value="<%= c.name %>"><%= c.name %></option>
                            <% }) %>
                        </select>
                    <% } else { %>
                        <p>No coupons available</p>
                    <% } %>

                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Paste coupon name" id="inputCoupon">
                        <button class="btn btn-primary" id="applyButton" type="button" onclick="applyCoupon('<%= totalAmount %>')">Apply</button>
                    </div>

                    <div class="total-card mt-3">
                        <table class="table table-borderless">
                            <tr>
                                <th>Shipping</th>
                                <td>Free</td>
                            </tr>
                            <tr>
                                <th>Discount</th>
                                <td id="discount"><%= locals.offerPrice || 0 %></td>
                            </tr>
                            <tr>
                                <th>Total</th>
                                <td id="totalValue">₹<%= totalAmount %></td>
                            </tr>
                        </table>

                        <% if (isSingle) { %>
                            <button class="btn btn-success w-100" onclick="handlePlaceOrder('<%= user._id %>', '<%= product[0]._id %>', true)">Place Order</button>
                        <% } else { %>
                            <button class="btn btn-success w-100" onclick="handlePlaceOrder('<%= user._id %>', [<% data.forEach((d,i)=>{ %>'<%= d.productDetails[0]._id %>'<% if(i<data.length-1){ %>, <% } %><% }) %>], false)">Place Order</button>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<%- include("../partials/footer") %>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
let orderInProgress = false;

function resetPlaceOrderButton() {
    orderInProgress = false;
    const btn = document.querySelector(".btn-success");
    if(btn) { btn.disabled = false; btn.innerText="Place Order"; }
}

function handlePlaceOrder(userId, productIds, isSingle){
    if(orderInProgress) return;

    const address = $("input[name='selectedAddress']:checked").val();
    if(!address){
        Swal.fire("NO ADDRESS FOUND!", "Please select your address.", "error"); return;
    }

    orderInProgress = true;
    const btn = document.querySelector(".btn-success");
    btn.disabled = true; btn.innerText="Processing...";

    placeOrder(userId, productIds, isSingle);
}

function placeOrder(userId, prodId, isSingle){
    const addressId = $("input[name='selectedAddress']:checked").val();
    const payment = $("input[name='payment_option']:checked").val();
    const totalAmount = parseInt($("#totalValue").text().replace(/[^\d]/g,""));

    if(!payment){ Swal.fire("NO PAYMENT FOUND!", "Please select payment", "error"); resetPlaceOrderButton(); return; }

    $.ajax({
        url:"/orderPlaced",
        method:"POST",
        data:{ totalPrice: totalAmount, addressId, payment, productId: prodId, isSingle },
        success:function(response){
            if(response.method==="cod" || response.method==="wallet"){
                if(response.payment){ Swal.fire("Order success","", "success").then(()=>location.href="/profile"); }
                else{
                    console.log(response);
                    
                    Swal.fire(response.method==="cod"?"COD not allowed above ₹1000":"Wallet balance insufficient","", "error");
                    resetPlaceOrderButton();
                }
            } else if(response.method==="online"){
                const options = {
                    key:"rzp_test_297s5pqDLLHUia",
                    amount: totalAmount*100,
                    currency:"INR",
                    name:"ThinkThankx",
                    order_id: response.razorpayOrder.id,
                    handler:function(paymentResponse){ verifyPayment(response.razorpayOrder.id, paymentResponse); },
                    modal:{ ondismiss: function(){ Swal.fire("Payment cancelled","","info"); resetPlaceOrderButton(); } },
                    theme:{ color:"#3399cc" }
                };
                const rzp = new Razorpay(options);
                rzp.on("payment.failed", function(response){
                    const failure_reason = response.error?.description || "Payment failed";
                    $.post("/savePendingOrder",{
                        order_id: response.error.metadata.order_id,
                        payment_id: response.error.metadata.payment_id,
                        user_id: userId,
                        product_id: prodId,
                        total_price: totalAmount,
                        address_id: addressId,
                        failure_reason: failure_reason,
                        failure_details: JSON.stringify(response.error)
                    }).done(()=>Swal.fire("Payment failed",failure_reason,"error"));
                    resetPlaceOrderButton();
                });
                rzp.open();
            }
        },
        error:function(){ Swal.fire("Order failed","Try again","error"); resetPlaceOrderButton(); }
    });
}

function verifyPayment(orderId, payment){
    $.post("/verifyPayment",{ orderId, payment }, function(res){
        if(res.status){ Swal.fire("Order success","","success").then(()=>location.href="/profile"); }
        else{ Swal.fire("Payment verification failed","","error"); resetPlaceOrderButton(); }
    }).fail(()=>{ Swal.fire("Verification error","","error"); resetPlaceOrderButton(); });
}

function confirmDeleteAddress(id){
    Swal.fire({title:'Confirm?',text:'Delete this address?',icon:'warning',showCancelButton:true,confirmButtonText:'Yes'})
        .then(result=>{
            if(result.isConfirmed) fetch(`/deleteAddress?id=${id}`,{method:'DELETE'})
                .then(r=>r.json()).then(data=>{
                    Swal.fire(data.success?'Deleted!':'Error',data.message,data.success?'success':'error')
                        .then(()=>location.reload());
                });
        });
}


/* COUPONS */
$("#couponDropdown").change(function(){
    const selectedCoupon = $(this).val();
    if(selectedCoupon) Swal.fire("Coupon Selected", selectedCoupon, "info");
});

$("#couponDropdown").on("change", function () {
    const selectedCoupon = $(this).val();

    if (!selectedCoupon) return;

    // Put selected coupon into input box
    $("#inputCoupon").val(selectedCoupon);

    Swal.fire({
        icon: "info",
        title: "Coupon Selected",
        text: selectedCoupon,
        timer: 1200,
        showConfirmButton: false
    });
});


function applyCoupon(total){
    if($("#applyButton").prop("disabled")) return;

    const coupon = $("#inputCoupon").val().trim();
    if(!coupon){
        Swal.fire("Enter a coupon code");
        return;
    }

    $.post("/applyCoupon", { coupon, total }, function(response){
        if(response.used){
            Swal.fire("Coupon already used");
        }
        else if(response.noCoupon){
            Swal.fire("Invalid coupon");
        }
        else{
            $("#inputCoupon").prop("readonly", true);
            $("#applyButton").prop("disabled", true);

            const gt = parseInt($("#totalValue").text().replace(/[^\d]/g,""));
            const discount = parseInt($("#discount").text());

            $("#totalValue").text("₹" + (gt - response.offerPrice));
            $("#discount").text(discount + response.offerPrice);

            Swal.fire("Coupon applied successfully", "", "success");
        }
    });
}



</script>
