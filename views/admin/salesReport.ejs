<%- include("../partials/adminHeader") %>

<style>
/* Dropdown styles */
.dropdown {
    position: relative;
    display: inline-block;
}
.dropdown-content {
    display: none;
    position: relative;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
    z-index: 1;
    bottom: 100%;
    left: 0;
    margin-bottom: 10px;
}
.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}
.dropdown-content a:hover { background-color: #f1f1f1; }
.dropdown:hover .dropdown-content { display: block; }
.dropdown:hover .dropbtn { background-color: #3e8e41; }
</style>

<div class="content-header row">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="content-title card-title">Sales Report</h2>
    </div>
</div>

<div class="card mb-4">
    <header class="card-header">
        <div class="container">
            <div class="row gx-3">

                <!-- Sales Report Selection -->
                <div class="col-lg-2 col-md-3 col-6">
                    <label for="salesReportSelection">Select Sales Report</label>
                    <select id="salesReportSelection" class="form-select" onchange="handleSalesReportChange(this.value)">
                        <option value="salesToday" <%= locals.salesToday ? 'selected' : '' %>>Sales Today</option>
                        <option value="salesWeekly" <%= locals.salesWeekly ? 'selected' : '' %>>Sales Weekly</option>
                        <option value="salesMonthly" <%= locals.salesMonthly ? 'selected' : '' %>>Sales Monthly</option>
                        <option value="salesYearly" <%= locals.salesYearly ? 'selected' : '' %>>Sales Yearly</option>
                        <% if (locals.startDate && locals.endDate) { %>
                            <option selected disabled>Custom Date Range</option>
                        <% } %>
                    </select>
                </div>

                <!-- Single Date Selection -->
                <div class="col-md-2 col-6">
                    <label for="selectedDate">Select Date</label>
                    <input type="date" id="selectedDate" class="form-control"
                        max="<%= new Date().toISOString().split('T')[0] %>"
                        value="<%= locals.date ? date : '' %>"
                        onchange="dateWiseFilter()">
                </div>

                <!-- Date Range Selection -->
                <div class="col-md-2 col-6">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" class="form-control"
                        max="<%= new Date().toISOString().split('T')[0] %>"
                        value="<%= locals.startDate ? startDate : '' %>"
                        onchange="dateRangeFilter()">
                </div>

                <div class="col-md-2 col-6">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" class="form-control"
                        max="<%= new Date().toISOString().split('T')[0] %>"
                        value="<%= locals.endDate ? endDate : '' %>"
                        onchange="dateRangeFilter()">
                </div>

                <!-- Generate Reports Buttons -->
                <div class="col-lg-4 col-md-6 ms-auto text-md-end">
                    <div class="dropdown">
                        <button class="btn btn-primary mb-2 dropbtn">Generate Report</button>
                        <div class="dropdown-content">
                            <a href="#" id="createSalesReport">Generate PDF</a>
                            <a href="#" id="downloadExcelReport">Download Excel</a>
                            <a href="#" id="createLedgerReport">Generate Chart</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </header>
</div>

<div class="right mt-5 container">
    <table id="salesTable" class="table table-hover">
        <thead>
            <tr>
                <th>#</th>
               
                <th>Name</th>
                <th>Product</th>
                <th>Date</th>
                <th>Payment</th>
                <th>Status</th>
                <th>Total</th>
                <th>Product/Category Cutoff</th>
                <th class="text-end">Coupon Cutoff</th>
                <th class="text-end">Final Price</th>
            </tr>
        </thead>
        <tbody>
            <% data.forEach((d, i) => { %>
                <tr>
                    <td><%= i+1 %></td>
                  
                    <td><b><%= d.address[0].name %></b></td>
                    <td><b><%= d.product[0].name || d.product._id %></b></td>
                    <td><%= new Date(d.createdOn).toLocaleString('en-IN') %></td>
                    <td><%= d.payment %></td>
                    <td><%= d.status %></td>
                    <td class="text-end"><%= d.product[0].price * 2 %></td>
                    <td class="text-end"><%= (d.product[0].price * 2) - d.totalPrice - d.couponDiscount %></td>
                    <td class="text-end"><%= d.couponDiscount %></td>
                    <td class="text-end"><%= d.totalPrice %></td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<% if (totalPages) { %>
<div class="pagination">
    <% if (currentPage > 1) { %>
        <button class="btn btn-sm">
            <a href="?page=<%= currentPage-1 %><%= filterQuery %>">Previous</a>
        </button>
    <% } %>
    <% for (let i=1; i<=totalPages; i++) { %>
        <button class="btn btn-sm <%= i === currentPage ? 'active' : '' %>">
            <a href="?page=<%= i %><%= filterQuery %>"><%= i %></a>
        </button>
    <% } %>
    <% if (currentPage < totalPages) { %>
        <button class="btn btn-sm">
            <a href="?page=<%= currentPage+1 %><%= filterQuery %>">Next</a>
        </button>
    <% } %>
</div>
<% } %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
/* =======================
   COMMON HELPERS
======================= */

function getToday() {
    return new Date().toISOString().split('T')[0];
}

// Fetch sales data from the table for export
function getSalesTableData() {
    const table = document.getElementById('salesTable');
    const tbody = table?.querySelector('tbody');
    if (!tbody || tbody.rows.length === 0) {
        Swal.fire("No Data", "No sales data available to generate report", "warning");
        return null;
    }
    const data = [];
    for (const row of tbody.rows) {
        const num = i => parseFloat(row.cells[i].textContent.replace(/[^\d.]/g, '')) || 0;
        data.push({
            dataId: row.cells[1].textContent.trim(),
            name: row.cells[2].textContent.trim(),
            product: row.cells[3].textContent.trim(),
            date: row.cells[4].textContent.split(',')[0].trim(),
            payment: row.cells[5].textContent.trim(),
            status: row.cells[6].textContent.trim(),
            totalAmount: num(7),
            productCutoff: num(8),
            couponCutoff: num(9),
            finalPrice: num(10)
        });
    }
    return data;
}

// Download file helper
async function downloadFile(url, data={}, filename) {
    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error("Failed to generate file");
        const blob = await res.blob();
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch(err) {
        Swal.fire("Error", err.message, "error");
    }
}

/* =======================
   EXPORT BUTTONS
======================= */

function getFilterParams() {
    const startDate = document.getElementById('startDate')?.value;
    const endDate = document.getElementById('endDate')?.value;
    const selectedDate = document.getElementById('selectedDate')?.value;
    const period = document.getElementById('salesReportSelection')?.value;

    const params = {};
    if (startDate && endDate) { params.startDate = startDate; params.endDate = endDate; }
    else if (selectedDate) { params.date = selectedDate; }
    else if (period) { params.day = period; }
    return params;
}

function buildQuery(params) {
    return Object.keys(params).map(k => `${k}=${params[k]}`).join('&');
}

document.getElementById('createSalesReport').addEventListener('click', () => {
    const params = buildQuery(getFilterParams());
    downloadFile('/admin/generatePdf?' + params, {}, 'sales-report.pdf');
});
document.getElementById('downloadExcelReport').addEventListener('click', () => {
    const params = buildQuery(getFilterParams());
    downloadFile('/admin/downloadExcel?' + params, {}, 'sales-report.xlsx');
});
document.getElementById('createLedgerReport').addEventListener('click', () => {
    const params = buildQuery(getFilterParams());
    downloadFile('/admin/generateLedgerPdf?' + params, {}, 'ledger-report.pdf');
});

/* =======================
   DATE FILTERS
======================= */

const today = getToday();
document.getElementById('selectedDate')?.setAttribute('max', today);
document.getElementById('startDate')?.setAttribute('max', today);
document.getElementById('endDate')?.setAttribute('max', today);

function dateWiseFilter() {
    const date = document.getElementById('selectedDate').value;
    if (!date) { Swal.fire("Select Date", "Please select a date", "warning"); return; }
    if (date > today) { Swal.fire("Invalid Date", "Future dates are not allowed", "error"); return; }
    window.location.href = `/admin/dateWiseFilter?date=${date}`;
}

function dateRangeFilter() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (!start || !end) return;
    if (start > end) { Swal.fire("Invalid Range","Start date cannot be greater than end date","error"); return; }
    if (start > today || end > today) { Swal.fire("Invalid Date","Future dates are not allowed","error"); return; }
    window.location.href = `/admin/dateRange?startDate=${start}&endDate=${end}`;
}

// Auto-limit end date based on start date
document.getElementById('startDate')?.addEventListener('change', function () {
    document.getElementById('endDate').setAttribute('min', this.value);
});

// Predefined period change
function handleSalesReportChange(value) {
    window.location.href = `/admin/salesReport?day=${value}`;
}
</script>

<%- include("../partials/adminFooter") %>
