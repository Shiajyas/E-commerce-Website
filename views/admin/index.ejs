<%- include("../partials/adminHeader") %>

<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Dashboard </h2>
            <p>Whole data about your business here</p>
        </div>
    
<!-- Filter Form -->
<form id="filterForm" class="row g-3" method="GET" action="/admin">

    <!-- Year -->
    <div class="col-md-3 col-6">
        <label for="selectedYear">Year</label>
        <select id="selectedYear" name="year" class="form-control">
            <% for (let i = 2000; i <= new Date().getFullYear(); i++) { %>
                <option value="<%= i %>" <%= year === i ? 'selected' : '' %>>
                    <%= i %>
                </option>
            <% } %>
        </select>
    </div>

    <!-- Month -->
  <!-- Month -->
<div class="col-md-3 col-6">
    <label for="selectedMonth">Month</label>
    <select id="selectedMonth" name="month" class="form-control">
        <option value="">All Months</option>
        <% 
            const months = [
                "January","February","March","April","May","June",
                "July","August","September","October","November","December"
            ];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
        %>

        <% months.forEach((m, i) => { 
            const monthNumber = i + 1;
            const isFutureMonth = (year === currentYear && monthNumber > currentMonth);
            if (!isFutureMonth) {
        %>
            <option value="<%= monthNumber %>" <%= month === monthNumber ? 'selected' : '' %>>
                <%= m %>
            </option>
        <% } }) %>
    </select>
</div>

    <!-- Start Date -->
    <div class="col-md-3 col-6">
        <label for="startDate">Start Date</label>
        <input
            type="date"
            id="startDate"
            name="startDate"
            class="form-control"
            max="<%= new Date().toISOString().split('T')[0] %>"
            value="<%= locals.startDate || '' %>"
        >
    </div>

    <!-- End Date -->
    <div class="col-md-3 col-6">
        <label for="endDate">End Date</label>
        <input
            type="date"
            id="endDate"
            name="endDate"
            class="form-control"
            max="<%= new Date().toISOString().split('T')[0] %>"
            value="<%= locals.endDate || '' %>"
        >
    </div>

    <!-- Submit -->
    <div class="col-md-2 col-6 align-self-end">
        <button class="btn btn-primary w-100" type="submit">
            Apply Filters
        </button>
    </div>

</form>

<script>
document.getElementById('filterForm').addEventListener('submit', function (e) {
    const year = document.getElementById('selectedYear').value;
    const month = document.getElementById('selectedMonth').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    // Case 1: Partial date range
    if ((startDate && !endDate) || (!startDate && endDate)) {
        e.preventDefault();
        Swal.fire({
            icon: 'warning',
            title: 'Invalid Date Range',
            text: 'Please select both Start Date and End Date.'
        });
        return;
    }

    // Case 2: Start date > end date
    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
        e.preventDefault();
        Swal.fire({
            icon: 'error',
            title: 'Invalid Date Range',
            text: 'Start Date cannot be greater than End Date.'
        });
        return;
    }

    // Case 3: If date range is used, ignore year/month
    if (startDate && endDate) {
        document.getElementById('selectedYear').disabled = true;
        document.getElementById('selectedMonth').disabled = true;
    }
});
</script>


    </div>
    <div class="row">
        <!-- Existing Revenue, Orders, Products, and Monthly Earning sections -->
        <!-- ... -->
        <div class="col-lg-3">
         <div class="card card-body mb-4">
             <article class="icontext">
                 <span class="icon icon-sm rounded-circle bg-primary-light"><i
                         class="text-primary material-icons md-monetization_on"></i></span>
                 <div class="text">
                     <h6 class="mb-1 card-title">Revenue</h6>
                     <span>₹<%= totalRevenue.toLocaleString() %></span>
                     <span class="text-sm">
                         Shipping fees are not included
                     </span>
                 </div>
             </article>
         </div>
   
     </div>
     <div class="col-lg-3">
         <div class="card card-body mb-4">
             <article class="icontext">
                 <span class="icon icon-sm rounded-circle bg-success-light"><i
                         class="text-success material-icons md-local_shipping"></i></span>
                 <div class="text">
                     <h6 class="mb-1 card-title">Orders</h6> <span>
                         <%= locals.orderCount %>
                     </span>
                     <span class="text-sm">
                         Excluding orders in transit
                     </span>
                 </div>
             </article>
         </div>
     </div>
     <div class="col-lg-3">
         <div class="card card-body mb-4">
             <article class="icontext">
                 <span class="icon icon-sm rounded-circle bg-warning-light"><i
                         class="text-warning material-icons md-qr_code"></i></span>
                 <div class="text">
                     <h6 class="mb-1 card-title">Products</h6> <span>
                         <%= locals.productCount %>
                     </span>
                     <span class="text-sm">
                         In <%= categoryCount %> Categories
                     </span>
                 </div>
             </article>
         </div>
     </div>
     <div class="col-lg-3">
         <div class="card card-body mb-4">
             <article class="icontext">
                 <span class="icon icon-sm rounded-circle bg-info-light"><i
                         class="text-info material-icons md-shopping_basket"></i></span>
                 <div class="text">
                     <h6 class="mb-1 card-title">Monthly Earning</h6> <span>₹<%= monthlyRevenue.toLocaleString()
                             %></span>
                     <span class="text-sm">
                         Based in your local time.
                     </span>
                 </div>
             </article>
         </div>
     </div>

    </div>
    <div class="row">
        <div class="col-xl-11 col-lg-12">
            <div class="card mb-4">
                <canvas id="myChart" height="120px"></canvas>
            </div>
        </div>
    </div>
    <div class="row">

      <div class="col-lg-7">
          <div class="card mb-4">
              <article class="card-body">
                  <h5 class="card-title">Recent activities</h5>
                  <ul class="verti-timeline list-unstyled font-sm">
                      <li class="event-list">
                          <div class="event-timeline-dot">
                              <i class="material-icons md-play_circle_outline font-xxl"></i>
                          </div>
                          <div class="media">
                              <div class="me-3">
                                  <h6><span>
                                          <%= latestOrders[0].createdOn.toLocaleDateString() %>
                                      </span> <i
                                          class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                                  </h6>
                              </div>
                              <div class="media-body">
                                  <div>
                                      <%= latestOrders[0].status %>: -
                                          <%= latestOrders[0].totalPrice %>
                                  </div>
                              </div>
                          </div>
                      </li>
                      <li class="event-list active">
                          <div class="event-timeline-dot">
                              <i
                                  class="material-icons md-play_circle_outline font-xxl animation-fade-right"></i>
                          </div>
                          <div class="media">
                              <div class="me-3">
                                  <h6><span>
                                    
                                      </span> <i
                                          class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                                  </h6>
                              </div>
                              <div class="media-body">
                                  <div>
                                      <%= latestOrders[1].status %>: -
                                          <%= latestOrders[1].totalPrice %>
                                  </div>
                              </div>
                          </div>
                      </li>
                      <li class="event-list">
                          <div class="event-timeline-dot">
                              <i class="material-icons md-play_circle_outline font-xxl"></i>
                          </div>
                          <div class="media">
                              <div class="me-3">
                                  <h6><span>
                                          <%= latestOrders[2].createdOn.toLocaleDateString() %>
                                      </span> <i
                                          class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                                  </h6>
                              </div>
                              <div class="media-body">
                                  <div>
                                      <%= latestOrders[2].status %>: -
                                          <%= latestOrders[2].totalPrice %>
                                  </div>
                              </div>
                          </div>
                      </li>
                      <li class="event-list">
                          <div class="event-timeline-dot">
                              <i class="material-icons md-play_circle_outline font-xxl"></i>
                          </div>
                          <div class="media">
                              <div class="me-3">
                                  <h6><span>
                                          <%= latestOrders[3].createdOn.toLocaleDateString() %>
                                      </span> <i
                                          class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                                  </h6>
                              </div>
                              <div class="media-body">
                                  <div>
                                      <%= latestOrders[3].status %>: -
                                          <%= latestOrders[3].totalPrice %>
                                  </div>
                              </div>
                          </div>
                      </li>
                      <li class="event-list">
                          <div class="event-timeline-dot">
                              <i class="material-icons md-play_circle_outline font-xxl"></i>
                          </div>
                          <div class="media">
                              <div class="me-3">
                                  <h6><span>
                                          <%= latestOrders[4].createdOn.toLocaleDateString() %>
                                      </span> <i
                                          class="material-icons md-trending_flat text-brand ml-15 d-inline-block"></i>
                                  </h6>
                              </div>
                              <div class="media-body">
                                  <div>
                                      <%= latestOrders[4].status %>: -
                                          <%= latestOrders[4].totalPrice %>
                                  </div>
                              </div>
                          </div>
                      </li>
                  </ul>
              </article>
          </div>
      </div>
  </div>
  <div class="row">
   <div class="col-xl-4 col-lg-6">
       <div class="card mb-4">
           <article class="card-body">
               <h5 class="card-title">Best Selling Products</h5>
               <select id="bestSellingProductsDropdown" class="form-select">
                   <% bestSellingProducts.forEach(product => { %>
                       <option value="<%= product._id %>"><%= product._id %> - <%= product.totalSold %></option>
                   <% }) %>
               </select>
           </article>
       </div>
   </div>
   <div class="col-xl-4 col-lg-6">
       <div class="card mb-4">
           <article class="card-body">
               <h5 class="card-title">Best Selling Categories</h5>
               <select id="bestSellingCategoriesDropdown" class="form-select">
                   <% bestSellingCategories.forEach(category => { %>
                       <option value="<%= category._id %>"><%= category._id %> - <%= category.totalSold %></option>
                   <% }) %>
               </select>
           </article>
       </div>
   </div>
   <div class="col-xl-4 col-lg-6">
       <div class="card mb-4">
           <article class="card-body">
               <h5 class="card-title">Best Selling Brands</h5>
               <select id="bestSellingBrandsDropdown" class="form-select">
                   <% bestSellingBrands.forEach(brand => { %>
                       <option value="<%= brand._id %>"><%= brand._id %> - <%= brand.totalSold %></option>
                   <% }) %>
               </select>
           </article>
       </div>
   </div>
</div>

</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<!-- Select2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.0/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/11.1.0/sweetalert.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Select2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>

<script>
document.getElementById('selectedYear').addEventListener('change', function () {
    const selectedYear = parseInt(this.value);
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;
    const monthSelect = document.getElementById('selectedMonth');

    // Reset months
    monthSelect.innerHTML = '<option value="">All Months</option>';

    const months = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
    ];

    months.forEach((month, index) => {
        const monthValue = index + 1;

        if (selectedYear < currentYear || monthValue <= currentMonth) {
            const option = document.createElement('option');
            option.value = monthValue;
            option.textContent = month;
            monthSelect.appendChild(option);
        }
    });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {

    /* ===============================
       Select2 Initialization
    ================================ */
    if (window.$ && $.fn.select2) {
        $('#bestSellingProductsDropdown').select2({ width: '100%' });
        $('#bestSellingCategoriesDropdown').select2({ width: '100%' });
        $('#bestSellingBrandsDropdown').select2({ width: '100%' });
    }

    /* ===============================
       Data from Backend (Safe)
    ================================ */
    const productPerMonth = <%- JSON.stringify(productPerMonth || []) %>;
    const monthlySalesArray = <%- JSON.stringify(monthlySalesArray || []) %>;

    /* ===============================
       LINE CHART (Monthly)
    ================================ */
    const lineCanvas = document.getElementById('myChart');
    if (!lineCanvas) return;

    const lineCtx = lineCanvas.getContext('2d');

    // Destroy existing chart if present
    const existingLineChart = Chart.getChart(lineCanvas);
    if (existingLineChart) {
        existingLineChart.destroy();
    }

    const lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
            labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
            datasets: [
                {
                    label: 'Products Added',
                    data: productPerMonth,
                    tension: 0.35,
                    fill: true,
                    backgroundColor: 'rgba(44,120,220,0.2)',
                    borderColor: 'rgba(44,120,220,1)',
                    pointRadius: 4
                },
                {
                    label: 'Sales Count',
                    data: monthlySalesArray,
                    tension: 0.35,
                    fill: true,
                    backgroundColor: 'rgba(4,209,130,0.2)',
                    borderColor: 'rgba(4,209,130,1)',
                    pointRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    labels: {
                        usePointStyle: true
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    /* ===============================
       PIE CHART (Reusable)
    ================================ */
    let pieChartInstance = null;

    window.createPieChart = function (labels = [], data = []) {
        const pieCanvas = document.getElementById('pieChart');
        if (!pieCanvas) return;

        const pieCtx = pieCanvas.getContext('2d');

        if (pieChartInstance) {
            pieChartInstance.destroy();
        }

        pieChartInstance = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: [
                        '#ff6384','#36a2eb','#ffce56','#4bc0c0',
                        '#9966ff','#ff9f40','#ff6384','#36a2eb',
                        '#ffce56','#4bc0c0'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    };

    /* ===============================
       Example Pie Chart Call
       (Call this dynamically on month select)
    ================================ */
    // createPieChart(
    //   ['Day 1','Day 2','Day 3','Day 4'],
    //   [1200, 900, 1500, 700]
    // );

});
</script>


<%- include("../partials/adminFooter") %>
