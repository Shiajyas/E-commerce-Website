<%- include("../partials/adminHeader") %>


    <style>
        .col-md-3 {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin: 10px;
        }

        .error-message {
            color: red;
            margin-top: 5px;
        }

        .form-label {
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .d-grid {
            margin-top: 20px;
        }

        .btn-primary {
            background-color: #007bff;
            color: #fff;
            border: 1px solid #007bff;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
    </style>

    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">Coupons </h2>

            </div>

        </div>
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <form id="createCouponForm">
                            <body onload="setDefaultStartDate()">
                                <div class="mb-4">
                                    <label for="coupon-name" class="form-label">Coupon Name</label>
                                    <input type="text" id="coupon-name" name="couponName" placeholder="Type here" class="form-control" required />
                                    <div id="error-coupon-name" class="error-message"></div>
                                </div>
                        
                                <div>
                                    <label for="startingDate" class="form-label">Start Date</label>
                                    <input type="date" name="startDate" class="form-control" required id="startingDate" />
                                    <div id="error-start-date" class="error-message"></div>
                                </div>
                        
                                <div>
                                    <label for="expiringDate" class="form-label">End Date</label>
                                    <input type="date" name="endDate" class="form-control" required id="expiringDate" />
                                    <div id="error-end-date" class="error-message"></div>
                                </div>
                        
                                <div>
                                    <label for="offer-price" class="form-label">Offer Price</label>
                                    <input type="text" name="offerPrice" placeholder="Type here" class="form-control" required />
                                    <div id="error-offer-price" class="error-message"></div>
                                </div>
                        
                                <div>
                                    <label for="minimum-price" class="form-label">Minimum Price</label>
                                    <input type="text" name="minimumPrice" placeholder="Type here" class="form-control" required />
                                    <div id="error-minimum-price" class="error-message"></div>
                                </div>
                        
                                <div class="d-grid">
                                    <button class="btn btn-primary mt-20" onclick="return validateForm(event)" type="submit">Add Coupon</button>
                                </div>
                        
                                <!-- Container for global error messages -->
                                <div id="err-msg" class="error-message"></div>
                            </body>
                        </form>
                        
                    </div>
                    <div class="col-md-7 ml-105">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Created On</th>
                                        <th>Expire On</th>
                                        <th>Offer Price</th>
                                        <th>Minimum Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% for (let i = 0; i < coupons.length; i++) { %>
                                    <tr>
                                        <td class="text-start"><%= coupons[i].name %></td>
                                        <td class="text-start"><%= new Date(coupons[i].createdOn).toLocaleDateString('en-US') %></td>
                                        <td class="text-start"><%= new Date(coupons[i].expireOn).toLocaleDateString('en-US') %></td>
                                        <td class="text-start"><%= coupons[i].offerPrice %></td>
                                        <td class="text-start"><%= coupons[i].minimumPrice %></td>
                                        <td class="text-start"><%= coupons[i].isList %></td>
                                        <td class="text-start">
                                            <button class="btn btn-danger btn-delete" data-id="<%= coupons[i].id %>">Delete</button>
                                        </td>
                                    </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                     <!-- .col// -->
                </div> <!-- .row // -->
            </div> <!-- card body .// -->
        </div> <!-- card .// -->
    </section> <!-- content-main end// -->

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
/* =========================================================
   DELETE COUPON
========================================================= */
$(document).ready(function () {
    $('.btn-delete').click(function () {
        const couponId = $(this).data('id');
        const row = $(this).closest('tr');

        Swal.fire({
            title: 'Are you sure?',
            text: "This action cannot be undone",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/admin/delete-coupon',
                    method: 'POST',
                    data: { id: couponId },
                    success: function (response) {
                        if (response.success) {
                            row.remove();
                            Swal.fire('Deleted!', 'Coupon deleted successfully.', 'success');
                        } else {
                            Swal.fire('Error', 'Failed to delete coupon.', 'error');
                        }
                    },
                    error: function () {
                        Swal.fire('Error', 'Server error while deleting coupon.', 'error');
                    }
                });
            }
        });
    });
});


/* =========================================================
   DATE DEFAULT + LIMITS
========================================================= */
window.onload = function () {
    const today = new Date().toISOString().split("T")[0];

    const startInput = document.getElementById("startingDate");
    const endInput = document.getElementById("expiringDate");

    if (startInput) {
        startInput.min = today;
        startInput.value = today;
    }

    if (endInput) {
        endInput.min = today;
    }
};


/* =========================================================
   FORM VALIDATION + SUBMISSION
========================================================= */

document.getElementById('createCouponForm').addEventListener('submit', function (event) {
    event.preventDefault();   // stop normal submit

    // Clear errors
    document.querySelectorAll('.error-message').forEach(el => el.innerText = '');

    const form = event.target;
    const formData = new FormData(form);

    const couponName = formData.get('couponName').trim();
    const startDate = formData.get('startDate');
    const endDate = formData.get('endDate');
    const offerPrice = Number(formData.get('offerPrice'));
    const minimumPrice = Number(formData.get('minimumPrice'));

    let valid = true;

    const today = new Date().toISOString().split("T")[0];

    /* ===== Coupon Name ===== */
    const nameRegex = /^[A-Za-z0-9]{3,50}$/;
    if (!nameRegex.test(couponName)) {
        document.getElementById('error-coupon-name').innerText =
            'Coupon name must be 3â€“50 characters (letters & numbers only)';
        valid = false;
    }

    /* ===== Start Date ===== */
    if (!startDate || startDate < today) {
        document.getElementById('error-start-date').innerText =
            'Start date cannot be in the past';
        valid = false;
    }

    /* ===== End Date ===== */
    if (!endDate || endDate < startDate) {
        document.getElementById('error-end-date').innerText =
            'End date must be after start date';
        valid = false;
    }

    /* ===== Offer Price ===== */
    if (isNaN(offerPrice) || offerPrice <= 0) {
        document.getElementById('error-offer-price').innerText =
            'Offer price must be a positive number';
        valid = false;
    }

    /* ===== Minimum Price ===== */
    if (isNaN(minimumPrice) || minimumPrice <= 0) {
        document.getElementById('error-minimum-price').innerText =
            'Minimum price must be a positive number';
        valid = false;
    }

    /* ===== Business Rule ===== */
    if (!isNaN(offerPrice) && !isNaN(minimumPrice) && offerPrice >= minimumPrice) {
        document.getElementById('error-offer-price').innerText =
            'Offer price must be less than minimum price';
        valid = false;
    }

    if (!valid) return;

    /* ===== Format Coupon Name ===== */
    const formattedName = formatCouponName(couponName);
    formData.set('couponName', formattedName);

    /* ===== Submit via Axios ===== */
    axios.post('/admin/createCoupon', formData)
        .then(function (response) {
            if (response.data.success) {
                Swal.fire({
                    title: 'Coupon Created',
                    text: 'Coupon created successfully.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.href = '/admin/coupon';
                });
            } else {
                Swal.fire('Error', response.data.message || 'Coupon already exists', 'error');
            }
        })
        .catch(function (error) {
            console.error('Create coupon error:', error);
            Swal.fire('Error', 'Server error while creating coupon.', 'error');
        });
});


/* =========================================================
   HELPERS
========================================================= */

function formatCouponName(name) {
    name = name.trim().toLowerCase();
    return name.charAt(0).toUpperCase() + name.slice(1);
}
</script>






    <%- include("../partials/adminFooter") %>